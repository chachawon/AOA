# 워크플로우의 이름입니다. GitHub Actions 탭에 표시됩니다.
name: Android CI & Release

# 이 워크플로우가 실행될 이벤트를 지정합니다.
on:
  # 'v'로 시작하는 태그(예: v1.0, v1.2.3)가 푸시될 때 실행됩니다.
  push:
    tags:
      - 'v*.*.*'
  # GitHub Actions 탭에서 수동으로 워크플로우를 실행할 수 있게 합니다.
  workflow_dispatch:

# 워크플로우에서 실행될 작업(job)들을 정의합니다.
jobs:
  build-and-release:
    # 작업이 실행될 환경을 지정합니다. 최신 Ubuntu 환경을 사용합니다.
    runs-on: ubuntu-latest

    # 작업 내에서 실행될 단계(step)들을 정의합니다.
    steps:
      # 1. 소스 코드 체크아웃
      # 현재 리포지토리의 코드를 가상 머신으로 가져옵니다.
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. JDK 17 설정
      # Android Gradle Plugin 8.4+는 JDK 17이 필요합니다.
      # Gradle 빌드 캐시를 활성화하여 빌드 속도를 향상시킵니다.
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      # 3. gradlew 실행 권한 부여
      # gradlew 스크립트를 실행할 수 있도록 권한을 설정합니다.
      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      # 4. (선택사항) Gradle 캐싱 설정
      # 의존성 다운로드 시간을 줄여 빌드를 더 빠르게 만듭니다.
      - name: Setup Gradle Dependencies Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # 5. 릴리즈 APK 빌드
      # ./gradlew assembleRelease 명령을 실행하여 서명된 릴리즈 APK를 생성합니다.
      # 앱 서명에 필요한 정보는 GitHub Secrets를 통해 안전하게 주입됩니다.
      - name: Build release APK
        run: ./gradlew assembleRelease
        env:
          # GitHub 리포지토리의 Secrets에 아래 값들을 등록해야 합니다.
          SIGNING_KEY_STORE_BASE64: ${{ secrets.SIGNING_KEY_STORE_BASE64 }}
          SIGNING_KEY_ALIAS: ${{ secrets.SIGNING_KEY_ALIAS }}
          SIGNING_KEY_STORE_PASSWORD: ${{ secrets.SIGNING_KEY_STORE_PASSWORD }}
          SIGNING_KEY_PASSWORD: ${{ secrets.SIGNING_KEY_PASSWORD }}

      # 6. 새 릴리즈 생성 및 APK 파일 업로드
      # softprops/action-gh-release 액션을 사용하여 GitHub 릴리즈를 생성합니다.
      - name: Create Release and Upload APK
        uses: softprops/action-gh-release@v2
        with:
          # 릴리즈에 포함될 파일들을 지정합니다.
          files: app/build/outputs/apk/release/app-release.apk
          # 릴리즈 노트를 자동으로 생성합니다. (이전 태그와의 커밋 내역 기반)
          generate_release_notes: true
